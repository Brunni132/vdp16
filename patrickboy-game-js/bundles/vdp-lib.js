!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("gl-matrix")):"function"==typeof define&&define.amd?define("vdp-lib",["gl-matrix"],e):"object"==typeof exports?exports["vdp-lib"]=e(require("gl-matrix")):t["vdp-lib"]=e(t.window)}(window,function(r){return function(r){var i={};function n(t){if(i[t])return i[t].exports;var e=i[t]={i:t,l:!1,exports:{}};return r[t].call(e.exports,e,e.exports,n),e.l=!0,e.exports}return n.m=r,n.c=i,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=1)}([function(t,e){t.exports=r},function(t,e,r){t.exports=r(2)},function(t,e,r){"use strict";var g,w;r.r(e);var E,A=1024,S=1024,M=1024,R=1024,B=256,n=!1,P=2048,_=16,i=!0,O=32768,p=[1,1,1,1];function L(){var t="float("+255/256*(256/E)+")",e="float("+16/E/16+")";return"\n\t\t\tfloat readTexel8(float x, float y) {\n\t\t\t\tint texelId = int(x / 4.0);\n\t\t\t\tvec4 read = texture2D(uSamplerSprites, vec2(float(texelId) / "+M+".0, y / "+R+".0));\n\t\t\t\tint texelC = int(x) - texelId * 4;\n\t\t\t\tif (texelC == 0) return read.r * "+t+";\n\t\t\t\tif (texelC == 1) return read.g * "+t+";\n\t\t\t\tif (texelC == 2) return read.b * "+t+";\n\t\t\t\treturn read.a * "+t+";\n\t\t\t}\n\t\t\t\n\t\t\tfloat extractTexelHi(float colorComp) {\n\t\t\t\tint intValue = int(colorComp * 255.0);\n\t\t\t\treturn float(intValue / 16) * "+e+";\n\t\t\t}\n\n\t\t\tfloat extractTexelLo(float colorComp) {\n\t\t\t\tint intValue = int(colorComp * 255.0);\n\t\t\t\treturn float(intValue - (intValue / 16) * 16) * "+e+";\n\t\t\t\t//return float(mod(float(intValue), 16.0)) * "+e+";\n\t\t\t}\n\t\n\t\t\tfloat readTexel4(float x, float y) {\n\t\t\t\tint texelId = int(x / 8.0);\n\t\t\t\tvec4 read = texture2D(uSamplerSprites, vec2(float(texelId) / "+M+".0, y / "+R+".0));\n\t\t\t\tint texelC = int(x) - texelId * 8;\n\t\t\t\t\n\t\t\t\tif (texelC == 0) return extractTexelHi(read.r);\n\t\t\t\tif (texelC == 1) return extractTexelLo(read.r);\n\t\t\t\tif (texelC == 2) return extractTexelHi(read.g);\n\t\t\t\tif (texelC == 3) return extractTexelLo(read.g);\n\t\t\t\tif (texelC == 4) return extractTexelHi(read.b);\n\t\t\t\tif (texelC == 5) return extractTexelLo(read.b);\n\t\t\t\tif (texelC == 6) return extractTexelHi(read.a);\n\t\t\t\treturn extractTexelLo(read.a);\n\t\t\t\t//return 9.0 * "+e+";\n\t\t\t}"}function F(t){return i?"vec4(("+t+").rgb * uEnvColor.rgb, 1)":t+" * uEnvColor"}var o=r(0),U=null,a=null;var s=function(t,e){this.texture=t,this.width=e.width,this.height=e.height};function f(t,e,r){var i=t.createShader(e);return t.shaderSource(i,r),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(alert("An error occurred compiling the shaders: "+t.getShaderInfoLog(i)),t.deleteShader(i),null)}function I(t,e,r){var i=f(t,t.VERTEX_SHADER,e),n=f(t,t.FRAGMENT_SHADER,r),o=t.createProgram();return t.attachShader(o,i),t.attachShader(o,n),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)?o:(alert("Unable to initialize the shader program: "+t.getProgramInfoLog(o)),null)}function u(e,r){var i=e.createTexture(),n=new Image;return e.bindTexture(e.TEXTURE_2D,i),new Promise(function(t){n.onload=function(){return e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),t(new s(i,n))},n.src=r})}function C(t){return t.createBuffer()}function l(t,e){a||(a=t.createFramebuffer()),e?(t.bindFramebuffer(t.FRAMEBUFFER,a),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0)):t.bindFramebuffer(t.FRAMEBUFFER,null)}function D(t,e,r,i,n,o){var a=new Uint8Array(n*o*4);return l(t,e),t.readPixels(r,i,n,o,t.RGBA,t.UNSIGNED_BYTE,a),l(t,null),a}function z(t,e){return[].concat.apply([],[t.slice(0,e),t.slice(e,2*e),t.slice(3*e,4*e),t.slice(0,1*e),t.slice(3*e,4*e),t.slice(2*e,3*e)])}var c=6,h=function(){function t(t,e){this.usedVertices=0,this.name=t,this.xyzp=new Float32Array(4*e),this.uv=new Float32Array(2*e),this.maxVertices=e}return t.prototype.computeUsedObjects=function(t,e){void 0===t&&(t=-1),void 0===e&&(e=-1);var r=0;t<0&&(t=this.firstSprite),e<0&&(e=this.usedSprites);for(var i=t;i<t+e;i++)r+=this.computeObjectCells(this.getSizeOfObject(i));return r},Object.defineProperty(t.prototype,"firstSprite",{get:function(){return this.firstVertice/c},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"firstVertice",{get:function(){return this.maxVertices-this.usedVertices},enumerable:!0,configurable:!0}),t.prototype.getZOfObject=function(t){return this.xyzp[4*c*t+2]},t.prototype.getSizeOfObject=function(t){var e=4*c*t;return{w:Math.abs(this.xyzp[e+8]-this.xyzp[e]),h:Math.abs(this.xyzp[e+8+1]-this.xyzp[e+1])}},t.prototype.limitObjList=function(t){for(var e=0,r=this.firstSprite+this.usedSprites,i=this.firstSprite;i<r;i++){var n=this.getSizeOfObject(i),o=this.computeObjectCells(n);if(t<e+o)return J&&console.log("Too many OBJ cells on ${this.name} (discarded ${endOfList - i}/${this.usedSprites} entries)"),i-this.firstSprite;e+=o}return this.usedSprites},t.prototype.sort=function(t){var r=this;void 0===t&&(t=!0);var i,e,n=(i=this.firstVertice/c,e=this.usedVertices/c,Array.from({length:e},function(t,e){return i+e}));t?n.sort(function(t,e){return r.getZOfObject(e)-r.getZOfObject(t)}):n.sort(function(t,e){return r.getZOfObject(t)-r.getZOfObject(e)});for(var o=this.xyzp.slice(),a=this.uv.slice(),s=0;s<n.length;s++)this.xyzp.set(o.subarray(4*c*n[s],4*c*(n[s]+1)),4*c*s),this.uv.set(a.subarray(2*c*n[s],2*c*(n[s]+1)),2*c*s)},Object.defineProperty(t.prototype,"usedSprites",{get:function(){return this.usedVertices/c},enumerable:!0,configurable:!0}),t.prototype.computeObjectCells=function(t){return Math.max(1,Math.ceil(t.w/32)*Math.ceil(t.h/32))},t}();function d(t,e){return new h(t,e*c)}var V=6,m=function(){function t(t,e){this.usedVertices=0,this.name=t,this.xyzp=new Float32Array(4*e),this.mapInfo1=new Float32Array(4*e),this.mapInfo2=new Float32Array(4*e),this.mapInfo3=new Float32Array(4*e),this.mapInfo4=new Float32Array(4*e),this.maxVertices=e}return Object.defineProperty(t.prototype,"firstVertice",{get:function(){return this.maxVertices-this.usedVertices},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"usedLayers",{get:function(){return this.usedVertices/V},enumerable:!0,configurable:!0}),t}();function x(t,e){if(!(e.usedVertices<3)){var r=t.gl,i=t.mapProgram,n=e.firstVertice;r.bindBuffer(r.ARRAY_BUFFER,i.glBuffers.xyzp),r.bufferData(r.ARRAY_BUFFER,e.xyzp.subarray(4*n),r.STREAM_DRAW),r.bindBuffer(r.ARRAY_BUFFER,i.glBuffers.mapInfo1),r.bufferData(r.ARRAY_BUFFER,e.mapInfo1.subarray(4*n),r.STREAM_DRAW),r.bindBuffer(r.ARRAY_BUFFER,i.glBuffers.mapInfo2),r.bufferData(r.ARRAY_BUFFER,e.mapInfo2.subarray(4*n),r.STREAM_DRAW),r.bindBuffer(r.ARRAY_BUFFER,i.glBuffers.mapInfo3),r.bufferData(r.ARRAY_BUFFER,e.mapInfo3.subarray(4*n),r.STREAM_DRAW),r.bindBuffer(r.ARRAY_BUFFER,i.glBuffers.mapInfo4),r.bufferData(r.ARRAY_BUFFER,e.mapInfo4.subarray(4*n),r.STREAM_DRAW),r.useProgram(i.program);var o=r.FLOAT,a=!1,s=0,f=0;r.bindBuffer(r.ARRAY_BUFFER,i.glBuffers.xyzp),r.vertexAttribPointer(i.attribLocations.xyzp,4,o,a,s,f),r.enableVertexAttribArray(i.attribLocations.xyzp);var u=4;o=r.FLOAT,a=!1,s=0,f=0;r.bindBuffer(r.ARRAY_BUFFER,i.glBuffers.mapInfo1),r.vertexAttribPointer(i.attribLocations.mapInfo1,u,o,a,s,f),r.enableVertexAttribArray(i.attribLocations.mapInfo1);u=4,o=r.FLOAT,a=!1,s=0,f=0;r.bindBuffer(r.ARRAY_BUFFER,i.glBuffers.mapInfo2),r.vertexAttribPointer(i.attribLocations.mapInfo2,u,o,a,s,f),r.enableVertexAttribArray(i.attribLocations.mapInfo2);u=4,o=r.FLOAT,a=!1,s=0,f=0;r.bindBuffer(r.ARRAY_BUFFER,i.glBuffers.mapInfo3),r.vertexAttribPointer(i.attribLocations.mapInfo3,u,o,a,s,f),r.enableVertexAttribArray(i.attribLocations.mapInfo3);u=4,o=r.FLOAT,a=!1,s=0,f=0;r.bindBuffer(r.ARRAY_BUFFER,i.glBuffers.mapInfo4),r.vertexAttribPointer(i.attribLocations.mapInfo4,u,o,a,s,f),r.enableVertexAttribArray(i.attribLocations.mapInfo4),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,t.spriteTexture),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,t.paletteTexture),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,t.mapTexture),r.activeTexture(r.TEXTURE3),r.bindTexture(r.TEXTURE_2D,t.otherTexture),r.uniform1i(i.uniformLocations.uSamplerSprites,0),r.uniform1i(i.uniformLocations.uSamplerPalettes,1),r.uniform1i(i.uniformLocations.uSamplerMaps,2),r.uniform1i(i.uniformLocations.uSamplerOthers,3),r.uniformMatrix4fv(i.uniformLocations.projectionMatrix,!1,t.projectionMatrix),r.uniformMatrix3fv(i.uniformLocations.modelViewMatrix,!1,t.modelViewMatrix),r.uniform4f(i.uniformLocations.envColor,p[0],p[1],p[2],p[3]),r.drawArrays(r.TRIANGLES,0,e.usedVertices),e.usedVertices=0}}function v(t,e){return new m(t,e*V)}var y=function(){function t(t,e,r,i,n,o){this.x=t,this.y=e,this.w=r,this.h=i,this.designTileset=n,this.designPalette=o}return t.prototype.offsetted=function(t,e,r,i){return this.x+=t,this.y+=e,this.w=r,this.h=i,this},t}(),T=function(){function t(t,e,r){this.y=t,this.w=e,this.h=r}return t.prototype.offsetted=function(t,e,r){return this.y+=t,this.w=e,this.h=r,this},t}(),b=function(){function t(t,e,r,i,n,o,a,s,f){this.x=t,this.y=e,this.w=r,this.h=i,this.tw=n,this.th=o,this.tiles=a,this.hiColor=s,this.designPalette=f}return t.prototype.offsetted=function(t,e,r,i){return this.x+=t,this.y+=e,this.w=r,this.h=i,this},t.prototype.tile=function(t){var e=Math.floor(this.w/this.tw);if(this.w/this.tw!==e)throw new Error("Not a tileset (w="+this.w+", h="+this.h+", tw="+this.tw+")");var r=t%e,i=Math.floor(t/e);return this.offsetted(r*this.tw,i*this.th,this.tw,this.th)},t}(),j=function(){function t(t,e,r){this.buffer=t,this.width=e,this.height=r}return t.prototype.getElement=function(t,e){return this.buffer[this.width*e+t]},t.prototype.setElement=function(t,e,r){this.buffer[this.width*e+t]=r},t}();var N=function(){function r(){}return r.extract=function(t,e){return void 0===e&&(e=8),{a:(t=r.posterize(t,e))>>>24,b:t>>>16&255,g:t>>>8&255,r:255&t}},r.make=function(t,e,r,i){return void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=255),"number"==typeof t?t|e<<8|r<<16|i<<24:t.r|t.g<<8|t.b<<16|t.a<<24},r.extendColor12=function(t){return r.reverseColor32(15&t|(15&t)<<4|(240&t)<<4|(240&t)<<8|(3840&t)<<8|(3840&t)<<12|(61440&t)<<12|(61440&t)<<16)},r.parse=function(t){if("string"==typeof t)switch("#"!==t.charAt(0)&&(t=""),t.length){case 4:return t=parseInt(t.substring(1),16),r.extendColor12(t<<4|15);case 5:return t=parseInt(t.substring(1),16),r.extendColor12(t);case 7:return t=parseInt(t.substring(1),16),r.reverseColor32(t<<8|255);case 9:return t=parseInt(t.substring(1),16),r.reverseColor32(t);default:throw new Error("Invalid color string "+t)}return t<=65535?r.extendColor12(t):t<=16777215?t|255<<24:t},r.posterize=function(t,e){if(2===e){var r=t>>>6&16843009|t>>>7&16843009;return(r|=r<<1)|r<<2|(t=t>>>6&50529027)<<4|t<<6}if(3===e){r=t>>>6&50529027;return(t=t>>>5&117901063)|t<<5|t<<2|r}if(4===e)return(t=t>>>4&252645135)|t<<4;if(5!==e)return t;r=t>>>5&117901063;return(t=t>>>3&522133279)|t<<3|r},r.reverseColor32=function(t){return(255&t)<<24|(t>>>8&255)<<16|(t>>>16&255)<<8|t>>>24&255},r.add=function(t,e){var r=(t>>>24)+(e>>>24),i=(t>>>16&255)+(e>>>16&255),n=(t>>>8&255)+(e>>>8&255),o=(255&t)+(255&e);return 255<r&&(r=255),255<i&&(i=255),255<n&&(n=255),255<o&&(o=255),o|n<<8|i<<16|r<<24},r.sub=function(t,e){var r=(t>>>24)-(e>>>24),i=(t>>>16&255)-(e>>>16&255),n=(t>>>8&255)-(e>>>8&255),o=(255&t)-(255&e);return r<0&&(r=0),i<0&&(i=0),n<0&&(n=0),o<0&&(o=0),o|n<<8|i<<16|r<<24},r.mul=function(t,e){return(255&t)*(255&e)/255|(t>>>8&255)*(e>>>8&255)/255<<8|(t>>>16&255)*(e>>>16&255)/255<<16|(t>>>24)*(e>>>24)/255<<24},r.blend=function(t,e,r){var i=1-(r=Math.min(1,Math.max(0,r)));return(255&t)*i+(255&e)*r|(t>>>8&255)*i+(e>>>8&255)*r<<8|(t>>>16&255)*i+(e>>>16&255)*r<<16|(t>>>24)*i+(e>>>24)*r<<24},r}(),X=function(){function f(t,e,r,i){this.posterizeToBpp=-1,this.buffer=t,this.width=e,this.height=r,this.pixelsPerTexel=i}return f.prototype.clone=function(){var t=new f(this.buffer.slice(0),this.width,this.height,this.pixelsPerTexel);return t.posterizeToBpp=this.posterizeToBpp,t},f.prototype.readToBuffer=function(t,e,r,i,n){if(typeof this.buffer!=typeof n)throw new Error("readFromShadowTexture: dest buffer must be of same type");for(var o=this.width*this.pixelsPerTexel,a=t+e*o,s=0,f=0;f<i;f++)n.set(this.buffer.subarray(a,a+r),s),a+=o,s+=r},f.prototype.setPosterization=function(t){if(this.buffer.constructor!==Uint32Array)throw new Error("Posterization only available for color buffers (32-bit)");this.posterizeToBpp=t},f.prototype.writeTo=function(t,e,r,i,n){if(typeof this.buffer!=typeof n)throw new Error("writeToShadowTexture: data must be of same type");for(var o=this.width*this.pixelsPerTexel,a=0,s=t+e*o,f=0;f<i;f++)this.buffer.set(n.subarray(a,a+r),s),a+=r,s+=o},f.prototype.syncToVramTexture=function(t,e,r,i,n,o){n=Math.ceil(n/this.pixelsPerTexel),0<r%this.pixelsPerTexel&&(n+=1),r=Math.floor(r/this.pixelsPerTexel);var a=new Uint32Array(n*o);if(new f(new Uint32Array(this.buffer.buffer),this.width,this.height,1).readToBuffer(r,i,n,o,a),1<=this.posterizeToBpp)for(var s=0;s<a.length;s++)a[s]=N.posterize(a[s],this.posterizeToBpp);t.bindTexture(t.TEXTURE_2D,e),t.texSubImage2D(t.TEXTURE_2D,0,r,i,n,o,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array(a.buffer))},f}();var Y,G,J=!0,W=function(){function t(t,e,r,i){this.effect=t,this.operation=e,this.blendSrc=r,this.blendDst=i}return t.prototype.apply=function(t){var e=t.gl,r=this.effect,i=this.blendSrc,n=this.blendDst,o=this.operation;if(p[0]=p[1]=p[2]=p[3]=1,e.blendEquation("sub"===o?e.FUNC_REVERSE_SUBTRACT:e.FUNC_ADD),"blend"===r)e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);else if("premult"===r)e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA);else if("color"===r){var a=N.extract(n,t.paletteBpp),s=N.extract(i,t.paletteBpp);e.blendColor(a.r/255,a.g/255,a.b/255,a.a/255),p[0]=s.r/255,p[1]=s.g/255,p[2]=s.b/255,p[3]=s.a/255,e.blendFunc(e.SRC_ALPHA,e.CONSTANT_COLOR),e.enable(e.BLEND)}else e.disable(e.BLEND)},t}();(G=Y||(Y={}))[G.current=0]="current",G[G.rom=1]="rom",G[G.blank=2]="blank";var k=function(){function t(){this.numLines=w,this.buffer=new Float32Array(8*this.numLines)}return t.prototype.getLine=function(t){if(t<0||t>=this.numLines)throw new Error("getLine: index "+t+" out of range");return o.mat3.fromValues(this.buffer[8*t],this.buffer[8*t+1],this.buffer[8*t+2],this.buffer[8*t+3],this.buffer[8*t+4],this.buffer[8*t+5],this.buffer[8*t+6],this.buffer[8*t+7],1)},t.prototype.setLine=function(t,e){if(t<0||t>=this.numLines)throw new Error("setLine: index "+t+" out of range");this.buffer.set(e.subarray(0,8),8*t)},t}(),H=new W("none","add",0,0),q=new W("blend","add",0,0),Z=function(){function t(t,b){var g=this;this.fadeColor=0,this.bgTransparency=new W("color","add",8947848,8947848),this.objTransparency=new W("color","add",8947848,8947848),this.bgBuffer=v("Opaque BG [BG]",4),this.tbgBuffer=v("Transparent BG [TBG]",1),this.obj0Buffer=d("Opaque sprites [OBJ0]",480),this.obj1Buffer=d("Transparent sprites [OBJ1]",32),this.stats={peakOBJ0:0,peakOBJ1:0,peakBG:0,OBJ0Limit:256},this.frameStarted=!0,this.nextLinescrollBuffer=0,this._initContext(t),this._initMatrices();var w=this.gl;window.fetch("build/game.json").then(function(t){return t.json()}).then(function(t){if(g.gameData=t,g.paletteBpp=t.info.paletteBpp,-1===[2,3,4,5,8].indexOf(g.paletteBpp))throw new Error("Unsupported paletteBpp "+g.paletteBpp);u(w,"build/sprites.png").then(function(T){var t,e;g.spriteTexture=T.texture,g.romSpriteTex=(t=T,e=new Uint8Array(D(w,t.texture,0,0,t.width,t.height).buffer),new X(e,t.width,t.height,4)),g.shadowSpriteTex=g.romSpriteTex.clone(),u(w,"build/palettes.png").then(function(y){if(!(256===y.width&&64===y.height||16===y.width&&256===y.height))throw new Error("Mismatch in texture size (max {16,256}x256");var t,e;g.paletteTexture=y.texture,g.romPaletteTex=(t=y,e=new Uint32Array(D(w,t.texture,0,0,t.width,t.height).buffer),new X(e,t.width,t.height,1)),g.shadowPaletteTex=g.romPaletteTex.clone(),8!==g.paletteBpp&&g.shadowPaletteTex.setPosterization(g.paletteBpp),u(w,"build/maps.png").then(function(t){var e,r,i,n,o,a,s,f,u,l,p,h,c,d,m,x,v;g.mapTexture=t.texture,g.romMapTex=(e=t,r=new Uint16Array(D(w,e.texture,0,0,e.width,e.height).buffer),new X(r,e.width,e.height,2)),g.shadowMapTex=g.romMapTex.clone(),i=y.width,n=y.height,o=t.width,a=t.height,s=T.width,f=T.height,B=n,E=i,M=s,R=f,A=o,S=a,g.otherTexture=function(t,e,r){U||(U=t.getExtension("OES_texture_float"));var i=t.createTexture(),n=new Float32Array(e*r*4);return n.fill(0),t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,r,0,t.RGBA,t.FLOAT,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),i}(w,P,P),g.configBDColor("#008"),l=(u=g).gl,p=I(l,"\n\t\t\tattribute vec4 aXyzp;\n\t\t\tattribute vec4 aMapInfo1;\n\t\t\tattribute vec4 aMapInfo2;\n\t\t\tattribute vec4 aMapInfo3;\n\t\t\tattribute vec4 aMapInfo4;\n\t\t\tuniform mat3 uModelViewMatrix;\n\t\t\tuniform mat4 uProjectionMatrix;\n\n\t\t\tvarying vec2 vTextureCoord;\n\t\t\tvarying float vPaletteNo;\n\t\t\t// TODO Florian -- use vec4 and extract in fragment program\n\t\t\tvarying highp vec2 vMapStart;\n\t\t\tvarying highp vec2 vMapSize;\n\t\t\tvarying vec2 vTilesetStart;\n\t\t\tvarying float vTilesetWidth;\n\t\t\tvarying vec2 vTileSize;\n\t\t\tvarying mat3 vTransformationMatrix;\n\t\t\t// [0] = linescroll buffer, if 0 use vTransformationMatrix always, [1] = whether to wrap around\n\t\t\tvarying vec2 vOtherInfo;\n\t\t\t\n\t\t\tuniform sampler2D uSamplerMaps, uSamplerSprites, uSamplerPalettes, uSamplerOthers;\n\t\t\n\t\t\tmat3 readLinescrollBuffer(int bufferNo, int horizOffset) {\n\t\t\t\tfloat vOfs = float(bufferNo) / "+_+".0;\n\t\t\t\tvec4 first = texture2D(uSamplerOthers, vec2(float(horizOffset) / "+P+".0, vOfs));\n\t\t\t\tvec4 second = texture2D(uSamplerOthers, vec2(float(horizOffset + 1) / "+P+".0, vOfs));\n\t\t\t\treturn mat3(\n\t\t\t\t\tfirst.xy, 0,\n\t\t\t\t\tvec2(first.a, second.r), 0,\n\t\t\t\t\tsecond.ba, 1.0);\n\t\t\t}\n\t\t\n\t\t\tvoid main(void) {\n\t\t\t\t// Only scale the final matrix (we can always say that the VDP supports fixed point math inside for matrix multiplication)\n\t\t\t\tgl_Position = uProjectionMatrix * vec4(floor(uModelViewMatrix * aXyzp.xyz), 1);\n\t\t\t\tvPaletteNo = floor(aXyzp.w);\n\t\t\t\tvMapStart = floor(aMapInfo1.xy);\n\t\t\t\tvTilesetStart = floor(aMapInfo1.zw);\n\t\t\t\tvMapSize = floor(aMapInfo2.xy);\n\t\t\t\tvTilesetWidth = floor(aMapInfo2.z);\n\t\t\t\tvTileSize = floor(aMapInfo3.xy);\n\t\t\t\tvTextureCoord = floor(aMapInfo3.zw);\n\t\t\t\tvOtherInfo = floor(aMapInfo4.xy);\n\t\t\t\t// If 0-255, use one transformation map-wide from the first line, if -1 never use transformations\n\t\t\t\tif (aMapInfo4.x >= 0.0 && aMapInfo4.x < 256.0) {\n\t\t\t\t\tvTransformationMatrix = readLinescrollBuffer(0, int(aMapInfo4.x) * 2);\n\t\t\t\t} else {\n\t\t\t\t\tvTransformationMatrix = mat3(\n\t\t\t\t\t\t1, 0, 0,\n\t\t\t\t\t\t0, 1, 0,\n\t\t\t\t\t\t0, 0, 1);\n\t\t\t\t}\n\t\t\t}\n\t\t","\n\t\t\tprecision highp float;\n\t\t\t\n\t\t\tvarying highp vec2 vTextureCoord;\n\t\t\tvarying highp float vPaletteNo;\n\t\t\tvarying highp vec2 vMapStart;\n\t\t\tvarying highp vec2 vMapSize;\n\t\t\t// tilesetSize is in tiles!\n\t\t\tvarying vec2 vTilesetStart;\n\t\t\tvarying float vTilesetWidth;\n\t\t\tvarying vec2 vTileSize;\n\t\t\tvarying mat3 vTransformationMatrix;\n\t\t\tvarying vec2 vOtherInfo;\n\t\t\t\n\t\t\tuniform mat3 uModelViewMatrix;\n\t\t\tuniform vec4 uEnvColor;\n\t\t\tuniform sampler2D uSamplerMaps, uSamplerSprites, uSamplerPalettes, uSamplerOthers;\n\t\t\t\t\t\t\n\t\t\tint intDiv(float x, float y) {\n\t\t\t\treturn int(floor(x / y));\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * Returns accurate MOD when arguments are approximate integers.\n\t\t\t * https://stackoverflow.com/questions/33908644/get-accurate-integer-modulo-in-webgl-shader\n\t\t\t */\n\t\t\tfloat modI(float a,float b) {\n\t\t\t\tfloat m=a-floor((a+0.5)/b)*b;\n\t\t\t\treturn floor(m+0.5);\n\t\t\t}\n\n\t\t\tmat3 readLinescrollBuffer(int bufferNo, int horizOffset) {\n\t\t\t\tfloat vOfs = float(bufferNo) / "+_+".0;\n\t\t\t\tvec4 first = texture2D(uSamplerOthers, vec2(float(horizOffset) / "+P+".0, vOfs));\n\t\t\t\tvec4 second = texture2D(uSamplerOthers, vec2(float(horizOffset + 1) / "+P+".0, vOfs));\n\t\t\t\treturn mat3(\n\t\t\t\t\tfirst.r, first.g, 0,\n\t\t\t\t\tfirst.a, second.r, 0,\n\t\t\t\t\tsecond.b, second.a, 1);\n\t\t\t}\n\t\t\t\n\t\t\tint readMap(int x, int y) {\n\t\t\t\tx = int(modI(float(x), vMapSize.x) + vMapStart.x);\n\t\t\t\ty = int(modI(float(y), vMapSize.y) + vMapStart.y);\n\t\t\t\t\n\t\t\t\tint texelId = x / 2;\n\t\t\t\tint texelC = x - texelId * 2;\n\t\t\t\tvec4 read = texture2D(uSamplerMaps, vec2(float(texelId) / "+A+".0, float(y) / "+S+".0));\n\t\t\t\tif (texelC == 0) return int(read.r * 255.0) + int(read.g * 255.0) * 256;\n\t\t\t\treturn int(read.b * 255.0) + int(read.a * 255.0) * 256;\n\t\t\t}\n\t\t\t\n\t\t\tvec2 positionInTexture(int tileNo) {\n\t\t\t\tvec2 base = vTilesetStart;\n\t\t\t\tfloat rowNo = float(tileNo / int(vTilesetWidth));\n\t\t\t\tfloat colNo = modI(float(tileNo), vTilesetWidth);\n\t\t\t\treturn base + vec2(colNo * vTileSize.x, rowNo * vTileSize.y);\n\t\t\t}\n\t\t\n\t\t\t"+L()+"\n\t\t\tvec4 readPalette(float x, float y) {\n\t\t\t\treturn texture2D(uSamplerPalettes, vec2(x, y));\n\t\t\t}\n\t\t\n\t\t\tvoid main(void) {\n\t\t\t\tmat3 transformationMatrix;\n\t\t\t\tfloat y = vTextureCoord.y;\n\t\t\t\t// Per-line info\n\t\t\t\tif (vOtherInfo.x >= 256.0) {\n\t\t\t\t\t// 2 colors (8 float values) per matrix\n\t\t\t\t\ttransformationMatrix = readLinescrollBuffer(int(vOtherInfo.x) - 256, int(y) * 2);\n\t\t\t\t\ty = 0.0;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\ttransformationMatrix = vTransformationMatrix;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tvec2 texCoord = floor((transformationMatrix * vec3(vTextureCoord.x, y, 1)).xy);\n\t\t\t\tint mapX = intDiv(texCoord.x, vTileSize.x), mapY = intDiv(texCoord.y, vTileSize.y);\n\t\t\t\t\n\t\t\t\t// Out of bounds?\n\t\t\t\tif (vOtherInfo.y < 1.0 && (mapX < 0 || mapY < 0 || mapX >= int(vMapSize.x) || mapY >= int(vMapSize.y))) {\n\t\t\t\t\tdiscard;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tint mapTileNo = readMap(mapX, mapY);\n\t\t\t\t// Invisible tile (TODO Florian -- support in the converter)\n\t\t\t\tif (mapTileNo >= 65535) discard;\n\n\t\t\t\t// Bits 12-15: palette No\n\t\t\t\tint palOfs = mapTileNo / 4096;\n\t\t\t\tfloat paletteOffset = float(palOfs);\n\t\t\t\tmapTileNo -= palOfs * 4096;\n\n\t\t\t\t// Position of tile no in sprite texture, now we need to add the offset\n\t\t\t\tvec2 offsetInTile = vec2(int(texCoord.x) - mapX * int(vTileSize.x), int(texCoord.y) - mapY * int(vTileSize.y));\n\t\t\t\tvec2 tilesetPos = positionInTexture(mapTileNo) + offsetInTile;\n\t\t\t\tfloat texel;\n\n\t\t\t\tif (vPaletteNo >= "+O+".0) {\n\t\t\t\t\ttexel = readTexel8(tilesetPos.x, tilesetPos.y);\n\t\t\t\t\tpaletteOffset += (vPaletteNo - "+O+".0);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\ttexel = readTexel4(tilesetPos.x, tilesetPos.y);\n\t\t\t\t\tpaletteOffset += vPaletteNo;\n\t\t\t\t}\n\n\t\t\t\t// if (vTextureCoord.x < 16.0) {\n\t\t\t\t// \tvec4 color = vec4(0, 0, 0, 1);\n\t\t\t\t// \t// float ym = mod(float(mapY), vMapSize.y) + vMapStart.y;\n\t\t\t\t// \t// color.b = (float(mapY) - ( float(mapY / int(vMapSize.y))) / 2.0;\n\t\t\t\t// \tint times = intDiv(float(mapY), vMapSize.y - 0.001);\n\t\t\t\t// \tcolor.g = modI(float(mapY), vMapSize.y) / 2.0;\n\t\t\t\t// \tcolor.b = float(mapY) / 28.0;\n\t\t\t\t// \tgl_FragColor = color;\n\t\t\t\t// }\n\t\t\t\t// else {\n\t\t\t\t\t// Color zero\n\t\t\t\t\tif (texel < "+1/E+") discard;\n\t\t\t\t\n\t\t\t\t\tvec4 color = readPalette(texel, paletteOffset / "+B+".0);\n\t\t\t\t\tgl_FragColor = "+F("color")+";\n\t\t\t\t// }\n\t\t\t}\n\t\t"),u.mapProgram={program:p,attribLocations:{xyzp:l.getAttribLocation(p,"aXyzp"),mapInfo1:l.getAttribLocation(p,"aMapInfo1"),mapInfo2:l.getAttribLocation(p,"aMapInfo2"),mapInfo3:l.getAttribLocation(p,"aMapInfo3"),mapInfo4:l.getAttribLocation(p,"aMapInfo4")},glBuffers:{xyzp:C(l),mapInfo1:C(l),mapInfo2:C(l),mapInfo3:C(l),mapInfo4:C(l)},uniformLocations:{envColor:l.getUniformLocation(p,"uEnvColor"),projectionMatrix:l.getUniformLocation(p,"uProjectionMatrix"),modelViewMatrix:l.getUniformLocation(p,"uModelViewMatrix"),uSamplerMaps:l.getUniformLocation(p,"uSamplerMaps"),uSamplerSprites:l.getUniformLocation(p,"uSamplerSprites"),uSamplerPalettes:l.getUniformLocation(p,"uSamplerPalettes"),uSamplerOthers:l.getUniformLocation(p,"uSamplerOthers")}},c=(h=g).gl,d=I(c,"\n\t\t\t// The 3 first are the vertex position, the 4th is the palette ID\n\t\t\tattribute vec4 aXyzp;\n\t\t\t// The 2 first are the texture position\n\t\t\tattribute vec2 aUv;\n\t\n\t\t\tuniform mat3 uModelViewMatrix;\n\t\t\tuniform mat4 uProjectionMatrix;\n\t\n\t\t\tvarying highp vec2 vTextureCoord;\n\t\t\tvarying highp float vPaletteNo;\n\t\t\tuniform sampler2D uSamplerSprites, uSamplerPalettes;\n\t\t\n\t\t\tvoid main(void) {\n\t\t\t\t// Only scale the final matrix (we can always say that the VDP supports fixed point math inside for matrix multiplication)\n\t\t\t\tgl_Position = uProjectionMatrix * vec4(floor(uModelViewMatrix * vec3(aXyzp.xy, aXyzp.z)), 1);\n\t\t\t\tvPaletteNo = aXyzp.w;\n\t\t\t\tvTextureCoord = floor(aUv);\n\t\t\t}\n\t\t","\n\t\t\tprecision highp float;\n\t\t\t\n\t\t\tvarying highp vec2 vTextureCoord;\n\t\t\tvarying highp float vPaletteNo;\n\t\t\tuniform vec4 uEnvColor;\n\t\t\tuniform sampler2D uSamplerSprites, uSamplerPalettes;\n\t\n\t\t\t"+L()+"\n\t\t\tvec4 readPalette(float x, float y) {\n\t\t\t\treturn texture2D(uSamplerPalettes, vec2(x, y));\n\t\t\t}\n\t\t\n\t\t\tvoid main(void) {\n\t\t\t\tfloat texel, palette;\n\t\t\t\tif (vPaletteNo >= "+O+".0) {\n\t\t\t\t\ttexel = readTexel8(vTextureCoord.x, vTextureCoord.y);\n\t\t\t\t\tpalette = (vPaletteNo - "+O+".0) / "+B+".0;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\ttexel = readTexel4(vTextureCoord.x, vTextureCoord.y);\n\t\t\t\t\tpalette = vPaletteNo / "+B+".0;\n\t\t\t\t}\n\n\t\t\t\t// Color zero\n\t\t\t\tif (texel < "+1/E+") discard;\n\n\t\t\t\tvec4 color = readPalette(texel, palette);\n\t\t\t\tgl_FragColor = "+F("color")+";\n\t\t\t}\n\t\t"),h.spriteProgram={program:d,attribLocations:{xyzp:c.getAttribLocation(d,"aXyzp"),uv:c.getAttribLocation(d,"aUv")},glBuffers:{xyzp:C(c),uv:C(c)},uniformLocations:{envColor:c.getUniformLocation(d,"uEnvColor"),projectionMatrix:c.getUniformLocation(d,"uProjectionMatrix"),modelViewMatrix:c.getUniformLocation(d,"uModelViewMatrix"),uSamplerSprites:c.getUniformLocation(d,"uSamplerSprites"),uSamplerPalettes:c.getUniformLocation(d,"uSamplerPalettes")}},x=(m=g).gl,v=I(x,"\n\t\t\tattribute vec2 aXy;\n\t\t\tattribute vec4 aColor;\n\t\n\t\t\tuniform mat3 uModelViewMatrix;\n\t\t\tuniform mat4 uProjectionMatrix;\n\t\n\t\t\tvarying lowp vec4 vColor;\n\t\t\n\t\t\tvoid main(void) {\n\t\t\t\tgl_Position = uProjectionMatrix * vec4(floor(uModelViewMatrix * vec3(aXy, 0)), 1);\n\t\t\t\tvColor = aColor;\n\t\t\t}\n\t\t","\n    varying lowp vec4 vColor;\n\n    void main(void) {\n      gl_FragColor = vColor;\n    }\n  "),m.opaquePolyProgram={program:v,arrayBuffers:{xy:new Float32Array(8),color:new Float32Array(16)},attribLocations:{xy:x.getAttribLocation(v,"aXy"),color:x.getAttribLocation(v,"aColor")},glBuffers:{xy:C(x),color:C(x)},uniformLocations:{projectionMatrix:x.getUniformLocation(v,"uProjectionMatrix"),modelViewMatrix:x.getUniformLocation(v,"uModelViewMatrix")}},b()})})})})}return t.prototype.configBDColor=function(t){this.shadowPaletteTex.buffer[0]=N.parse(t)},t.prototype.configBGTransparency=function(t){if("add"!==t.op&&"sub"!==t.op)throw new Error("Invalid operation "+t.op);this.bgTransparency.operation=t.op,this.bgTransparency.blendSrc=N.parse(t.blendSrc),this.bgTransparency.blendDst=N.parse(t.blendDst)},t.prototype.configFade=function(t,e){e=Math.min(255,Math.max(0,e)),this.fadeColor=16777215&N.parse(t)|e<<24},t.prototype.configOBJTransparency=function(t){if("add"!==t.op&&"sub"!==t.op)throw new Error("Invalid operation "+t.op);this.objTransparency.operation=t.op,this.objTransparency.blendSrc=N.parse(t.blendSrc),this.objTransparency.blendDst=N.parse(t.blendDst)},t.prototype.drawBG=function(t,e){void 0===e&&(e={}),"string"==typeof t&&(t=this.map(t));var r=this._getPalette(e.hasOwnProperty("palette")?e.palette:t.designPalette),i=this._getSprite(e.hasOwnProperty("tileset")?e.tileset:t.designTileset),n=e.hasOwnProperty("scrollX")?e.scrollX:0,o=e.hasOwnProperty("scrollY")?e.scrollY:0,a=e.hasOwnProperty("winX")?e.winX:0,s=e.hasOwnProperty("winY")?e.winY:0,f=e.hasOwnProperty("winW")?e.winW:g-a,u=e.hasOwnProperty("winH")?e.winH:w-s,l=!e.hasOwnProperty("wrap")||e.wrap,p=e.prio||0,h=e.transparent?this.tbgBuffer:this.bgBuffer;if(4<=this.bgBuffer.usedLayers+this.tbgBuffer.usedLayers)J&&console.log("Too many BGs ("+this.bgBuffer.usedLayers+" opaque, "+this.tbgBuffer.usedLayers+" transparent), ignoring drawBG");else{a=Math.min(g,Math.max(0,a)),s=Math.min(w,Math.max(0,s)),f=Math.min(g-a,Math.max(0,f)),u=Math.min(w-s,Math.max(0,u));var c,d,m,x,v,y,T,b=-1;e.lineTransform&&(b=256+this.nextLinescrollBuffer,c=this.gl,d=this.otherTexture,m=0,x=this.nextLinescrollBuffer++,v=e.lineTransform.buffer.length/4,y=1,T=e.lineTransform.buffer,c.bindTexture(c.TEXTURE_2D,d),c.texSubImage2D(c.TEXTURE_2D,0,m,x,v,y,c.RGBA,c.FLOAT,T)),function(t,e,r,i,n,o,a,s,f,u,l,p,h,c,d,m,x,v,y,T,b){if(void 0===y&&(y=-1),void 0===T&&(T=1),void 0===b&&(b=0),d+=l,m+=p,s=Math.floor(s/f),v&&(x|=O),t.usedVertices>=t.maxVertices)J&&console.log(t.name+" overuse (max "+t.maxVertices/V+"), ignoring drawBG");else{t.usedVertices+=V;var g=t.firstVertice;t.xyzp.set(z([l,p,b,x,l+h,p,b,x,l,p+c,b,x,l+h,p+c,b,x],4),4*g),t.mapInfo1.set(z([e,r,i,n,e,r,i,n,e,r,i,n,e,r,i,n],4),4*g),t.mapInfo2.set(z([o,a,s,0,o,a,s,0,o,a,s,0,o,a,s,0],4),4*g),t.mapInfo3.set(z([f,u,d,m,f,u,d+h,m,f,u,d,m+c,f,u,d+h,m+c],4),4*g),t.mapInfo4.set(z([y,T,0,0,y,T,0,0,y,T,0,0,y,T,0,0],4),4*g)}}(h,t.x,t.y,i.x,i.y,t.w,t.h,i.w,i.tw,i.th,a,s,f,u,n,o,r.y,i.hiColor,b,l?1:0,p)}},t.prototype.drawObj=function(t,e,r,i){void 0===i&&(i={}),"string"==typeof t&&(t=this.sprite(t));var n=this._getPalette(i.hasOwnProperty("palette")?i.palette:t.designPalette),o=i.hasOwnProperty("width")?i.width:t.w,a=i.hasOwnProperty("height")?i.height:t.h,s=i.prio||1;!function(t,e,r,i,n,o,a,s,f,u,l,p){if(void 0===p&&(p=0),l&&(u|=O),t.usedVertices>=t.maxVertices)J&&console.log(t.name+" overuse (max "+t.maxVertices/c+"), ignoring drawOBJ");else{t.usedVertices+=c;var h=t.firstVertice;t.xyzp.set(z([e,r,p,u,i,r,p,u,e,n,p,u,i,n,p,u],4),4*h),t.uv.set(z([o,a,s,a,o,f,s,f],2),2*h)}}(i.transparent?this.obj1Buffer:this.obj0Buffer,e,r,e+o,r+a,t.x,t.y,t.x+t.w,t.y+t.h,n.y,t.hiColor,s)},t.prototype.getStats=function(){var t=this.stats;return this.stats={peakOBJ0:0,peakOBJ1:0,peakBG:0,OBJ0Limit:256},t},t.prototype.map=function(t){var e=this.gameData.maps[t];if(!e)throw new Error("Map "+t+" not found");return new y(e.x,e.y,e.w,e.h,e.til,e.pal)},t.prototype.palette=function(t){var e=this.gameData.pals[t];if(!e)throw new Error("Palette "+t+" not found");return new T(e.y,e.w,e.h)},t.prototype.readMap=function(t,e){void 0===e&&(e=Y.current);var r=this._getMap(t),i=new Uint16Array(r.w*r.h);return e===Y.current&&this.shadowMapTex.readToBuffer(r.x,r.y,r.w,r.h,i),e===Y.rom&&this.romMapTex.readToBuffer(r.x,r.y,r.w,r.h,i),new j(i,r.w,r.h)},t.prototype.readPalette=function(t,e){void 0===e&&(e=Y.current);var r=this._getPalette(t);return this.readPaletteMemory(0,r.y,r.w,r.h,e)},t.prototype.readPaletteMemory=function(t,e,r,i,n){void 0===n&&(n=Y.current);var o=new Uint32Array(r*i);return n===Y.current&&this.shadowPaletteTex.readToBuffer(t,e,r,i,o),n===Y.rom&&this.romPaletteTex.readToBuffer(t,e,r,i,o),new j(o,r,i)},t.prototype.readSprite=function(t,e){void 0===e&&(e=Y.current);var r=this._getSprite(t);if(!r.hiColor&&r.x%2!=0)throw new Error("Lo-color sprites need to be aligned to 2 pixels");var i=r.hiColor?r.x:r.x/2,n=r.hiColor?r.w:Math.ceil(r.w/2),o=new Uint8Array(n*r.h);return e===Y.current&&this.shadowSpriteTex.readToBuffer(i,r.y,n,r.h,o),e===Y.rom&&this.romSpriteTex.readToBuffer(i,r.y,n,r.h,o),new j(o,n,r.h)},t.prototype.sprite=function(t){var e=this.gameData.sprites[t];if(!e)throw new Error("Sprite "+t+" not found");return new b(e.x,e.y,e.w,e.h,e.tw,e.th,e.tiles,e.hicol,e.pal)},t.prototype.writeMap=function(t,e){var r=this._getMap(t);this.shadowMapTex.writeTo(r.x,r.y,r.w,r.h,e.buffer),this.shadowMapTex.syncToVramTexture(this.gl,this.mapTexture,r.x,r.y,r.w,r.h)},t.prototype.writePalette=function(t,e){var r=this._getPalette(t);this.writePaletteMemory(0,r.y,r.w,r.h,e)},t.prototype.writePaletteMemory=function(t,e,r,i,n){this.shadowPaletteTex.writeTo(t,e,r,i,n.buffer),this.shadowPaletteTex.syncToVramTexture(this.gl,this.paletteTexture,t,e,r,i)},t.prototype.writeSprite=function(t,e){var r=this._getSprite(t);if(!r.hiColor&&r.x%2!=0)throw new Error("Lo-color sprites need to be aligned to 2 pixels");var i=r.hiColor?r.x:r.x/2,n=r.hiColor?r.w:Math.ceil(r.w/2);this.shadowSpriteTex.writeTo(i,r.y,n,r.h,e.buffer),this.shadowSpriteTex.syncToVramTexture(this.gl,this.paletteTexture,i,r.y,n,r.h)},t.prototype._computeStats=function(t){this.stats.peakBG=Math.max(this.stats.peakBG,this.bgBuffer.usedLayers+this.tbgBuffer.usedLayers),this.stats.peakOBJ0=Math.max(this.stats.peakOBJ0,this._totalUsedOBJ0()),this.stats.peakOBJ1=Math.max(this.stats.peakOBJ1,this._totalUsedOBJ1()),this.stats.OBJ0Limit=Math.min(this.stats.OBJ0Limit,t)},t.prototype._doRender=function(){var t=this.gl;if(J&&this._computeStats(256),this.frameStarted){var e=N.extract(this.shadowPaletteTex.buffer[0],this.paletteBpp);t.clearColor(e.r/255,e.g/255,e.b/255,0),t.clearDepth(1),t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),this.frameStarted=!1}H.apply(this),o.mat3.identity(this.modelViewMatrix),x(this,this.bgBuffer),this._drawObjLayer(this.obj0Buffer,256),this.bgTransparency.apply(this),t.depthMask(!1),x(this,this.tbgBuffer),t.depthMask(!0),this.obj1Buffer.sort(),this.objTransparency.apply(this),this._drawObjLayer(this.obj1Buffer,64),this.nextLinescrollBuffer=0},t.prototype._drawObjLayer=function(t,e){void 0===e&&(e=0),o.mat3.identity(this.modelViewMatrix),function(t,e,r){void 0===r&&(r=0);var i=e.usedSprites;if(0<r&&(i=e.limitObjList(r)),!(i<=0)){var n=t.spriteProgram,o=t.gl,a=e.firstVertice;o.bindBuffer(o.ARRAY_BUFFER,n.glBuffers.xyzp),o.bufferData(o.ARRAY_BUFFER,e.xyzp.subarray(4*a),o.STREAM_DRAW),o.bindBuffer(o.ARRAY_BUFFER,n.glBuffers.uv),o.bufferData(o.ARRAY_BUFFER,e.uv.subarray(2*a),o.STREAM_DRAW),o.useProgram(n.program);var s=o.FLOAT,f=!1,u=0,l=0;o.bindBuffer(o.ARRAY_BUFFER,n.glBuffers.xyzp),o.vertexAttribPointer(n.attribLocations.xyzp,4,s,f,u,l),o.enableVertexAttribArray(n.attribLocations.xyzp),s=o.FLOAT,f=!1,l=u=0,o.bindBuffer(o.ARRAY_BUFFER,n.glBuffers.uv),o.vertexAttribPointer(n.attribLocations.uv,2,s,f,u,l),o.enableVertexAttribArray(n.attribLocations.uv),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,t.spriteTexture),o.activeTexture(o.TEXTURE1),o.bindTexture(o.TEXTURE_2D,t.paletteTexture),o.uniform1i(n.uniformLocations.uSamplerSprites,0),o.uniform1i(n.uniformLocations.uSamplerPalettes,1),o.uniformMatrix4fv(n.uniformLocations.projectionMatrix,!1,t.projectionMatrix),o.uniformMatrix3fv(n.uniformLocations.modelViewMatrix,!1,t.modelViewMatrix),o.uniform4f(n.uniformLocations.envColor,p[0],p[1],p[2],p[3]),o.drawArrays(o.TRIANGLES,0,i*c),e.usedVertices=0}}(this,t,e),o.mat3.identity(this.modelViewMatrix)},t.prototype._endFrame=function(){if(this._doRender(),16<=this.fadeColor>>>24){var t=this.gl,e=N.extract(this.fadeColor,this.paletteBpp),r=e.r,i=e.g,n=e.b,o=e.a;q.apply(this),t.disable(t.DEPTH_TEST),function(t,e,r,i,n,o,a,s,f){var u=t.gl,l=t.opaquePolyProgram,p=[e,r,i,r,e,n,i,n],h=[o,a,s,f,o,a,s,f,o,a,s,f,o,a,s,f];u.bindBuffer(u.ARRAY_BUFFER,l.glBuffers.xy),u.bufferData(u.ARRAY_BUFFER,new Float32Array(p),u.STREAM_DRAW),u.bindBuffer(u.ARRAY_BUFFER,l.glBuffers.color),u.bufferData(u.ARRAY_BUFFER,new Float32Array(h),u.STREAM_DRAW),u.useProgram(l.program);var c=u.FLOAT,d=!1,m=0,x=0;u.bindBuffer(u.ARRAY_BUFFER,l.glBuffers.xy),u.vertexAttribPointer(l.attribLocations.xy,2,c,d,m,x),u.enableVertexAttribArray(l.attribLocations.xy),c=u.FLOAT,d=!1,x=m=0,u.bindBuffer(u.ARRAY_BUFFER,l.glBuffers.color),u.vertexAttribPointer(l.attribLocations.color,4,c,d,m,x),u.enableVertexAttribArray(l.attribLocations.color),u.uniformMatrix4fv(l.uniformLocations.projectionMatrix,!1,t.projectionMatrix),u.uniformMatrix3fv(l.uniformLocations.modelViewMatrix,!1,t.modelViewMatrix),x=0,u.drawArrays(u.TRIANGLE_STRIP,x,4)}(this,0,0,g,w,r/255,i/255,n/255,o/255)}},t.prototype._getMap=function(t){return"string"==typeof t?this.map(t):t},t.prototype._getPalette=function(t){return"string"==typeof t?this.palette(t):t},t.prototype._getSprite=function(t){return"string"==typeof t?this.sprite(t):t},t.prototype._initContext=function(t){this.gl=t.getContext("webgl",{premultipliedAlpha:!0,alpha:n}),null===this.gl&&alert("Unable to initialize WebGL. Your browser or machine may not support it.")},t.prototype._initMatrices=function(){this.projectionMatrix=o.mat4.create(),o.mat4.ortho(this.projectionMatrix,0,g,w,0,-10,10),this.modelViewMatrix=o.mat3.create()},t.prototype._startFrame=function(){this.frameStarted=!0},t.prototype._totalUsedOBJ0=function(){return this.obj0Buffer.computeUsedObjects()},t.prototype._totalUsedOBJ1=function(){return this.obj1Buffer.computeUsedObjects()},t}(),$=59.94,K=1/($+1),Q=1/$,tt=1/($-1),et=function(){function t(){this.last=0,this.late=0,this.framerateSum=30*Q}return t.prototype.doForSmoothness=function(t){var e=this._timeDiff(t);if(this._addToFramerate(e),tt<e?(this.late+=e-tt,.25<this.late&&(this.late=0)):e<K&&(this.late+=e-K),this.last=t,this.late<=-Q)return this.late+=Q,0;if(this.late>=Q){var r=Math.floor(this.late/Q);return this.late-=r*Q,1+r}return 1},t.prototype.doSimplest=function(t){var e=this._timeDiff(t);return this._addToFramerate(e),this.last=t,1},t.prototype.doStandard=function(t){var e=this._timeDiff(t);if(this._addToFramerate(e),this.late+=e-Q,.25<this.late&&(this.late=0),this.last=t,this.late>=Q){var r=Math.floor(this.late/Q);return this.late-=r*Q,1+r}return this.late<=-Q?(this.late+=Q,0):1},t.prototype.getFramerate=function(){return 30/this.framerateSum},t.prototype._addToFramerate=function(t){t<.25&&(this.framerateSum=29*this.framerateSum/30+t)},t.prototype._timeDiff=function(t){return(t-this.last)/1e3},t}();function rt(r){var t,e,i;return t=r.width,e=r.height,void 0===(i=!1)&&(i=!1),g=t,w=e,n=i,new Promise(function(t){var e=new Z(r,function(){e._startFrame(),t(e)})})}function it(t,e){rt(document.querySelector("#glCanvas")).then(function(t){return f=e(s=t),u=0,l=[],p=new et,c=h=0,void window.requestAnimationFrame(function t(e){if(J){var r=Math.floor(e/1e3);r!==u&&0<l.length&&(console.log("Upd="+(l.reduce(function(t,e){return t+e})/l.length).toFixed(3)+"ms; r="+h+", s="+c+", u="+l.length+"; "+p.getFramerate().toFixed(2)+"Hz",s.getStats()),l.length=0,h=c=0),u=r}var i,n=p.getFramerate();i=$-1<=n&&n<=$+1?p.doSimplest(e):p.doStandard(e);for(var o=0;o<i;o++){var a=window.performance.now();s._startFrame(),f.next(),s._endFrame(),l.push(window.performance.now()-a)}J&&(0<i&&(h+=1),1<i&&(c+=i-1)),window.requestAnimationFrame(t)});var s,f,u,l,p,h,c})}r.d(e,"startGame",function(){return it}),r.d(e,"LineTransformationArray",function(){return k})}])});
//# sourceMappingURL=vdp-lib.js.map